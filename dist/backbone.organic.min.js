var Organic=function(a,b,c){"use strict";var d={};return b.Organic=d,d.Deferred=b.$.Deferred,d.extend=b.Model.extend,d.noop=function(){},d.isNodeAttached=function(a){return b.$.contains(document.documentElement,a)},d.throwError=function(a,b){var c=new Error(a);throw c.name=b||"Error",c},d.getOption=function(a,b){if(a&&b){var c=a.options,d=c&&"undefined"!=typeof c[b];return(d?c:a)[b]}},d.proxyGetOption=function(a){return d.getOption(this,a)},d.callResult=function(a,b,d){return c.isFunction(a)?a.call(b||this,d):a},d.applyResult=function(a,b,d){return c.isFunction(a)?a.apply(b||this,d):a},d.mixCollectionMethods=function(a,b){var d=["forEach","each","map","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","toArray","first","initial","rest","last","without","isEmpty","pluck"];c.each(d,function(d){a[d]=function(){var a=c.values(c.result(this,b)),e=[a].concat(c.toArray(arguments));return c[d].apply(c,e)}})},d.normalizeMethods=function(a){return c.reduce(a,function(a,b,d){return c.isFunction(b)||(b=this[b]),b&&(a[d]=b),a},{},this)},d.normalizeUIString=function(a,b){return a.replace(/@ui\.[a-zA-Z_$0-9]*/g,function(a){return b[a.slice(4)]})},d.normalizeUIKeys=function(a,b){return c.reduce(a,function(a,c,e){var f=d.normalizeUIString(e,b);return a[f]=c,a},{})},d.normalizeUIValues=function(a,b){return c.each(a,function(e,f){c.isString(e)&&(a[f]=d.normalizeUIString(e,b))}),a},d._triggerMethod=function(){function a(a,b,c){return c.toUpperCase()}var b=/(^|:)(\w)/gi;return function(d,e,f){var g=arguments.length<3;g&&(f=e,e=f[0]);var h,i="on"+e.replace(b,a),j=d[i];return c.isFunction(j)&&(h=j.apply(d,g?c.rest(f):f)),c.isFunction(d.trigger)&&(g+f.length>1?d.trigger.apply(d,g?f:[e].concat(c.rest(f,0))):d.trigger(e)),h}}(),d.triggerMethod=function(){return d._triggerMethod(this,arguments)},d.triggerMethodOn=function(a){var b=c.isFunction(a.triggerMethod)?a.triggerMethod:d.triggerMethod;return b.apply(a,c.rest(arguments))},d.MonitorDOMRefresh=function(a){function b(){a._isShown=!0,f()}function e(){a._isRendered=!0,f()}function f(){a._isShown&&a._isRendered&&d.isNodeAttached(a.el)&&c.isFunction(a.triggerMethod)&&a.triggerMethod("dom:refresh")}a.on({show:b,render:e})},function(a){function b(b,d,e,f){d&&e&&(e=a.callResult(e,b),c.isObject(e)||a.throwError("Bindings must be an object.","BindingError"),c.each(e,function(a,e){var g=c.isFunction(a)?f.func:f.str;g(b,d,e,a)}))}function d(b,d,e,g){var h=g.split(/\s+/);c.each(h,function(c){var g=b[c];g||a.throwError('Method "'+c+'" was configured as an event handler, but does not exist.',"BindingError"),f(b,d,e,g)})}function e(a,b,d,e){var f=e.split(/\s+/);c.each(f,function(c){var e=a[c];g(a,b,d,e)})}function f(a,b,c,d){a.listenTo(b,c,d)}function g(a,b,c,d){a.stopListening(b,c,d)}a.bindEntityEvents=function(a,c,e){b(a,c,e,{func:f,str:d})},a.unbindEntityEvents=function(a,c,d){b(a,c,d,{func:g,str:e})},a.proxyBindEntityEvents=function(b,c){return a.bindEntityEvents(this,b,c)},a.proxyUnbindEntityEvents=function(b,c){return a.unbindEntityEvents(this,b,c)}}(d),function(a){function d(a,b){return c.isArray(a)?a.concat(b):c.isObject(a)?c.extend({},a,b):void 0}function e(){var a=this.prototype,b=this.__super__;return a.mergeProps===b.mergeProps&&(a.mergeProps=[]),c(b._mergeProps.concat(a.mergeProps)).each(function(c){var e=a[c],f=b[c];if(e!==f){var g=d(f,e);g&&(a[c]=g)}}),this}function f(a){var b=this.extend(a);return e.call(b)}a.mixMerge=function(a,b,c){a.merge||(a.merge=f),arguments.length<3&&(c=b,b=void 0),b?c&&(a.prototype._mergeProps=(b.prototype._mergeProps||[]).concat(c)):a.prototype._mergeProps=c},a.mixMerge(b.Model,["defaults","relations"]),a.mixMerge(b.Collection),a.mixMerge(b.View,["events"]),a.mixMerge(b.Router),a.a=function(){}}(d),d.Emitter=function(a){this.options=a||{},c.isFunction(this.initialize)&&this.initialize(this.options),this._callBeforeDestroy=c.once(function(){d._triggerMethod(this,"before:destroy",arguments)})},d.Emitter.extend=b.Model.extend,c.extend(d.Emitter.prototype,b.Events,{destroy:function(){return this._callBeforeDestroy.apply(this,arguments),d._triggerMethod(this,"destroy",arguments),this.stopListening(),this.off(),this},triggerMethod:d.triggerMethod,getOption:d.proxyGetOption}),d.Region=function(a){this.options=a||{},this.el=this.getOption("el"),this.el=this.el instanceof b.$?this.el[0]:this.el,this.el||d.throwError('An "el" must be specified for a region.',"NoElError"),this.$el=this.getEl(this.el),c.isFunction(this.initialize)&&this.initialize.apply(this,arguments)},c.extend(d.Region,{buildRegion:function(a,b){return c.isString(a)?this._buildRegionFromSelector(a,b):a.selector||a.el||a.regionClass?this._buildRegionFromObject(a,b):c.isFunction(a)?this._buildRegionFromRegionClass(a):void d.throwError("Improper region configuration type.")},_buildRegionFromSelector:function(a,b){return new b({el:a})},_buildRegionFromObject:function(a,e){var f=a.regionClass||e||d.Region,g=c.omit(a,"selector","regionClass");a.selector&&!g.el&&(g.el=a.selector);var h=new f(g);return a.parentEl&&(h.getEl=function(d){if(c.isObject(d))return b.$(d);var e=c.result(a,"parentEl");return e.find(d)}),h},_buildRegionFromRegionClass:function(a){return new a}}),c.extend(d.Region.prototype,b.Events,{show:function(a,b){this._ensureElement(),b=b||{};var c=a!==this.currentView,e=c&&!b.preventDestroy,f=c||b.forceShow;return e&&this.empty(),f&&(a.once("destroy",this.empty,this),a.render(),this.triggerMethod("before:show",a),d.triggerMethodOn(a,"before:show"),this.attachViewHtml(a),this.currentView=a,this.triggerMethod("show",a),d.triggerMethodOn(a,"show")),this},showHtml:function(a){return this._ensureElement(),this.empty(),this.attachHtml(a),this},_ensureElement:function(){c.isObject(this.el)||(this.$el=this.getEl(this.el),this.el=this.$el[0]),this.$el&&0!==this.$el.length||d.throwError('An "el" '+this.$el.selector+" must exist in DOM")},getEl:function(a){return b.$(a)},attachViewHtml:function(a){this.attachHtml(a.el)},attachHtml:function(a){this.$el.html(a)},empty:function(){var a=this.currentView;if(a)return this.triggerMethod("before:empty",a),this._destroyView(),this.triggerMethod("empty",a),delete this.currentView,this},_destroyView:function(){var a=this.currentView;a.destroy&&!a.isDestroyed?a.destroy():a.remove&&(a.remove(),a.isDestroyed=!0)},attachView:function(a){return this.currentView=a,this},hasView:function(){return!!this.currentView},reset:function(){return this.empty(),this.$el&&(this.el=this.$el.selector),delete this.$el,this},getOption:d.proxyGetOption,triggerMethod:d.triggerMethod}),d.Region.extend=d.extend,d.RegionManager=d.Emitter.extend({constructor:function(a){this._regions={},d.Emitter.call(this,a)},addRegions:function(a,b){a=d.applyResult(a,this,arguments);var e={};return c.each(a,function(a,d){c.isString(a)&&(a={selector:a}),a.selector&&(a=c.defaults({},a,b)),e[d]=this.addRegion(d,a)},this),e},addRegion:function(a,b){var c=b instanceof d.Region?b:d.Region.buildRegion(b,d.Region);return this.triggerMethod("before:add:region",a,c),this._store(a,c),this.triggerMethod("add:region",a,c),c},get:function(a){return this._regions[a]},removeRegion:function(a){var b=this._regions[a];b.empty(),b.stopListening(),delete this._regions[a],this._setLength(),this.triggerMethod("remove:region",a,b)},removeAllRegions:function(){var a=c.keys(this._regions);c.each(a,this.removeRegion,this)},resetAllRegions:function(){var a=c.keys(this._regions);c.each(a,function(a){this._regions[a].reset()},this)},destroy:function(){return this.removeAllRegions(),d.Emitter.prototype.destroy.apply(this,arguments)},_store:function(a,b){this._regions[a]=b,this._setLength()},_setLength:function(){this.length=c.keys(this._regions).length}}),d.mixCollectionMethods(d.RegionManager.prototype,"_regions"),d.Renderer={render:function(a,b){return a?"function"==typeof a?a(b):a:""}},d.BaseView=b.View.extend({constructor:function(a){c.bindAll(this,"render"),this.options=c.extend({},c.result(this,"options"),d.callResult(a,this)),b.View.apply(this,arguments),d.MonitorDOMRefresh(this)},getTemplate:function(){return this.getOption("template")},normalizeUIKeys:function(a){var b=c.result(this,"ui"),e=c.result(this,"_uiBindings");return d.normalizeUIKeys(a,e||b)},normalizeUIValues:function(a){var b=c.result(this,"ui"),e=c.result(this,"_uiBindings");return d.normalizeUIValues(a,e||b)},configureTriggers:function(){if(this.triggers){var a=this.normalizeUIKeys(c.result(this,"triggers")),b={};return c.each(a,function(a,d){var e=c.isObject(a),f=e?a.event:a;b[d]=function(b,c){if(b){var d=b.preventDefault,g=b.stopPropagation,h=e?a.preventDefault:d,i=e?a.stopPropagation:g;h&&d&&d.call(b),i&&g&&g.call(b)}this.triggerMethod(f,{view:this,model:this.model,collection:this.collection},c)}},this),b}},delegateEvents:function(a){return this._delegateDOMEvents(a),this.bindEntityEvents(this.model,this.getOption("modelEvents")),this.bindEntityEvents(this.collection,this.getOption("collectionEvents")),this},_delegateDOMEvents:function(a){a=d.callResult(a||this.events,this),a=this.normalizeUIKeys(a),this.events=a;var e={},f=this.configureTriggers();c.extend(e,a,f),b.View.prototype.delegateEvents.call(this,e)},undelegateEvents:function(){return b.View.prototype.undelegateEvents.apply(this,arguments),this.unbindEntityEvents(this.model,this.getOption("modelEvents")),this.unbindEntityEvents(this.collection,this.getOption("collectionEvents")),this},destroy:function(){return this.isDestroyed?this:(d._triggerMethod(this,"before:destroy",arguments),this.isDestroyed=!0,d._triggerMethod(this,"destroy",arguments),this.unbindUIElements(),this.remove(),this)},bindUIElements:function(){if(this.ui){this._uiBindings||(this._uiBindings=this.ui);var a=c.result(this,"_uiBindings");this.ui={},c.each(c.keys(a),function(b){var c=a[b];this.ui[b]=this.$(c)},this)}},unbindUIElements:function(){this.ui&&this._uiBindings&&(c.each(c.keys(this.ui),function(a){delete this.ui[a]},this),this.ui=this._uiBindings,delete this._uiBindings)},render:function(){return this._ensureViewIsIntact(),this.triggerMethod("before:render",this),this._renderTemplate(),this.bindUIElements(),this.triggerMethod("render",this),this},attachElContent:function(a){return this.$el.html(a),this},_renderTemplate:function(){var a=this.getTemplate();if(a!==!1){var b=d.Renderer.render(a);return this.attachElContent(b),this}},_ensureViewIsIntact:function(){this.isDestroyed&&d.throwError('View (cid: "'+this.cid+'") has already been destroyed and cannot be used.',"ViewDestroyedError")},triggerMethod:d.triggerMethod,normalizeMethods:d.normalizeMethods,getOption:d.proxyGetOption,bindEntityEvents:d.proxyBindEntityEvents,unbindEntityEvents:d.proxyUnbindEntityEvents}),d.mixMerge(d.BaseView,b.View,["ui","triggers"]),d.View=d.BaseView.extend({serializeData:function(){if(!this.model&&!this.collection)return{};var a=[this.model||this.collection];return arguments.length&&a.push.apply(a,arguments),this.model?this.serializeModel.apply(this,a):{items:this.serializeCollection.apply(this,a)}},serializeModel:function(a){return a.toJSON.apply(a,c.rest(arguments))},serializeCollection:function(a){return a.toJSON.apply(a,c.rest(arguments))},mixinTemplateHelpers:function(a){var b=this.getOption("templateHelpers");return c.extend(a||{},d.callResult(b,this))},_renderTemplate:function(){var a=this.getTemplate();if(a!==!1){var b=this.serializeData();b=this.mixinTemplateHelpers(b);var c=d.Renderer.render(a,b);return this.attachElContent(c),this}}}),d.Layout=d.View.extend({regionClass:d.Region,constructor:function(a){a=a||{},this._firstRender=!0,this._initRegions(a),d.View.call(this,a)},render:function(){return this._ensureViewIsIntact(),this._firstRender?this._firstRender=!1:this.regionManager.resetAllRegions(),d.View.prototype.render.apply(this,arguments)},destroy:function(){return this.isDestroyed?this:(this.regionManager.destroy(),d.View.prototype.destroy.apply(this,arguments))},addRegion:function(a,b){var c={};return c[a]=b,this._buildRegions(c)[a]},addRegions:function(a){return this.regionsDecl=c.extend({},this.regionsDecl,a),this._buildRegions(a)},removeRegion:function(a){return delete this.regionsDecl[a],this.regionManager.removeRegion(a)},getRegionManager:function(){return new d.RegionManager},_initRegionManager:function(){this.regionManager=this.getRegionManager(),this.regions={},this.listenTo(this.regionManager,"add:region",function(a,b){this.regions[a]=b}),this.listenTo(this.regionManager,"remove:region",function(a){delete this.regions[a]})},_buildRegions:function(a){var b=this,c={regionClass:this.getOption("regionClass"),parentEl:function(){return b.$el}};return this.regionManager.addRegions(a,c)},_initRegions:function(a){this._initRegionManager();var b=c.extend({},d.callResult(this.regionsDecl,this,a));c.keys(b).length&&(b=this.normalizeUIValues(b),this._buildRegions(b))}}),d.Router=b.Router.extend({constructor:function(a){b.Router.apply(this,arguments),this.options=a||{};var c=this.getOption("appRoutes"),d=this.getOption("handlers"),e=this.getOption("handlersContext");this._processAppRoutes(d,c,e)},route:function(a,d,e){c.isFunction(d)?e=d:e||(e=this[d]);var f=c.bind(function(){this.trigger("before:route"),e.apply(this,arguments)},this);return b.Router.prototype.route.call(this,a,d,f)},destroy:function(){return d._triggerMethod(this,"destroy",arguments),this.stopListening(),this.off(),this.stop(),this},stop:function(){var a=this.getOption("appRoutes");return c.each(c.keys(a),function(a){this._removeFromHistory(a)},this),this},_removeFromHistory:function(a){var d=b.history.handlers,e=c.find(d,function(b){var c=this._routeToRegExp(a);return b.route.source===c.source},this);e&&(b.history.handlers=c.without(d,e))},_processAppRoutes:function(a,b,e){var f=c.keys(b).reverse();c.each(f,function(f){var g=b[f],h=a[g];h||d.throwError('Method "'+g+'" was not found on the handlers'),e&&(h=c.bind(h,e)),this.route(f,g,h)},this)},triggerMethod:d.triggerMethod,getOption:d.proxyGetOption}),d.Slot=function(a){a||d.throwError("Region is not defined"),this.region=a},c.extend(d.Slot.prototype,{setHtml:function(a){return this.empty(),this.region.showHtml(a),this},setView:function(a){return this.empty(),this.view=new a,this.region.show(this.view),this},set:function(a){return this.empty(),this.data=c.rest(arguments),this.block=new a,this.active()},active:function(){this.block||d.throwError("Slot does not contain block","SlotActivationError"),this.data||(this.data=[]);var a=this,c=this.block;return d._triggerMethod(c,"before:prepare",this.data),b.$.when(c.prepare.apply(c,this.data)).then(function(){return c.lazy&&c._createInternalInstances(),a.region.show(c.getView()),d._triggerMethod(c,"prepare",a.data),c})},empty:function(){this.block&&(this.block.destroy(),delete this.block),this.view&&(this.view.destroy(),delete this.view)},getBlock:function(){return this.block},triggerMethod:d.triggerMethod}),d.SlotManager=d.Emitter.extend({constructor:function(a){this._slots={},d.Emitter.call(this,a)},removeSlot:function(a){this._slots[a].empty(),delete this._slots[a],this.triggerMethod("remove:slot",a)},removeSlots:function(){c.each(c.keys(this._slots),this.removeSlot,this)},addSlot:function(a,b){var c=new d.Slot(a);return this._slots[b]=c,this.triggerMethod("add:slot",b,c),c},addSlots:function(a){c.each(a,this.addSlot,this)},destroy:function(){return this.removeSlots(),d.Emitter.prototype.destroy.apply(this,arguments)}}),d.SlotKeeper=d.Emitter.extend({constructor:function(a){this.lazy===!1&&this._createInternalInstances(),d.Emitter.call(this,a)},destroy:function(){return this._callBeforeDestroy.apply(this,arguments),this.slotManager&&(this.slotManager.destroy(),delete this.slotManager),this.view&&(this.unbindEntityEvents(this.view,this.viewEvents),this.view.destroy(),delete this.view),d.Emitter.prototype.destroy.apply(this,arguments)},getView:function(){return this.view},getViewClass:function(){return this.viewClass},_createInternalInstances:function(){"undefined"==typeof this.view&&(this.view=this._createView()),this.view&&(this._initSlots(),this.bindEntityEvents(this.view,this.viewEvents))},_createView:function(){var a=this.getViewClass();return"function"!=typeof a&&d.throwError("`viewClass` is not defined","SlotKeeperInitError"),new a(this._getViewOptions())},_initSlotManager:function(){this.slots={},this.slotManager=new d.SlotManager,this.listenTo(this.slotManager,"add:slot",function(a,b){this.slots[a]=b}),this.listenTo(this.slotManager,"remove:slot",function(a){delete this.slots[a]})},_initSlots:function(){var a=this.view.regions;c.keys(a).length&&(this._initSlotManager(),this.slotManager.addSlots(a))},_getViewOptions:function(){return this.viewOptions},lazy:!1,bindEntityEvents:d.proxyBindEntityEvents,unbindEntityEvents:d.proxyUnbindEntityEvents}),d.Block=d.SlotKeeper.extend({destroy:function(){return this._callBeforeDestroy.apply(this,arguments),this.model&&(this.unbindEntityEvents(this.model,this.modelEvents),delete this.model),this.collection&&(this.unbindEntityEvents(this.collection,this.collectionEvents),this.collection.reset(),delete this.collection),d.SlotKeeper.prototype.destroy.apply(this,arguments)},getCollectionClass:function(){return this.collectionClass},getCollection:function(){return this.collection},getModelClass:function(){return this.modelClass},getModel:function(){return this.model},_createInternalInstances:function(){return"undefined"==typeof this.model&&(this.model=this._createModel()),this.model&&this.bindEntityEvents(this.model,this.modelEvents),"undefined"==typeof this.collection&&(this.collection=this._createCollection()),this.collection&&this.bindEntityEvents(this.collection,this.collectionEvents),d.SlotKeeper.prototype._createInternalInstances.apply(this,arguments)},_createModel:function(){var a=this.getModelClass();return"function"==typeof a?new a:void 0},_createCollection:function(){var a=this.getCollectionClass();return"function"==typeof a?new a:void 0},_getViewOptions:function(){var a={};return this.model&&(a.model=this.model),this.collection&&(a.collection=this.collection),c.extend(a,this.viewOptions)},prepare:d.noop}),d.Bundle=d.SlotKeeper.extend({constructor:function(a){a&&a.region||d.throwError("Region in not defined","BundleInitError"),c.bindAll(this,"_onBeforeRoute","_onViewClose"),this.view=a.view,this.region=a.region,this.isActive=!1,this._routers={},d.SlotKeeper.call(this,a.options),this.listenTo(this.view,"close",this._onViewClose)},initRouter:function(a){var b=this._routers[a]=new this.routersDecl[a]({handlersContext:this});return this.listenTo(b,"before:route",this._onBeforeRoute),b.triggerMethod("init",this),b},initRouters:function(){c.each(c.keys(this.routersDecl),function(a){this.initRouter(a)},this)},getRouter:function(a){return"undefined"==typeof this._routers[a]&&d.throwError("Router is not initialized"),this._routers[a]},_onBeforeRoute:function(){this.isActive||(this.region.show(this.view),this.isActive=!0,this.triggerMethod("render"),c.each(c.keys(this._routers),function(a){this._routers[a].triggerMethod("render",this)},this))},_onViewClose:function(){this.isActive=!1},destroy:function(){return c.each(c.keys(this._routers),function(a){this._routers[a].destroy(this),delete this._routers[a]},this),d.SlotKeeper.prototype.destroy.apply(this,arguments)}}),d}(this,Backbone,_);
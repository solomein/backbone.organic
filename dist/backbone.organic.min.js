!function(a,b){if("function"==typeof define&&define.amd)define(["backbone","underscore"],function(c,d){return a.Organic=b(a,c,d)});else if("undefined"!=typeof exports){var c=require("backbone"),d=require("underscore");module.exports=b(a,c,d)}else a.Organic=b(a,a.Backbone,a._)}(this,function(a,b,c){"use strict";var d=a.Organic,e=b.Organic={};return e.noConflict=function(){return a.Organic=d,this},e.extend=b.Model.extend,e.noop=function(){},e.isNodeAttached=function(a){return b.$.contains(document.documentElement,a)},e.throwError=function(a,b){var c=new Error(a);throw c.name=b||"Error",c},e.getOption=function(a,b){if(a&&b){var c=a.options,d=c&&"undefined"!=typeof c[b];return(d?c:a)[b]}},e.proxyGetOption=function(a){return e.getOption(this,a)},e.callResult=function(a,b,d){return c.isFunction(a)?a.call(b||this,d):a},e.applyResult=function(a,b,d){return c.isFunction(a)?a.apply(b||this,d):a},e.mixCollectionMethods=function(a,b){var d=["forEach","each","map","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","toArray","first","initial","rest","last","without","isEmpty","pluck"];c.each(d,function(d){a[d]=function(){var a=c.values(c.result(this,b)),e=[a].concat(c.toArray(arguments));return c[d].apply(c,e)}})},e.normalizeMethods=function(a){return c.reduce(a,function(a,b,d){return c.isFunction(b)||(b=this[b]),b&&(a[d]=b),a},{},this)},e.normalizeUIString=function(a,b){return a.replace(/@ui\.[a-zA-Z_$0-9]*/g,function(a){return b[a.slice(4)]})},e.normalizeUIKeys=function(a,b){return c.reduce(a,function(a,c,d){var f=e.normalizeUIString(d,b);return a[f]=c,a},{})},e.normalizeUIValues=function(a,b){return c.each(a,function(d,f){c.isString(d)&&(a[f]=e.normalizeUIString(d,b))}),a},e._triggerMethod=function(){function a(a,b,c){return c.toUpperCase()}var b=/(^|:)(\w)/gi;return function(d,e,f){var g=arguments.length<3;g&&(f=e,e=f[0]);var h,i="on"+e.replace(b,a),j=d[i];return c.isFunction(j)&&(h=j.apply(d,g?c.rest(f):f)),c.isFunction(d.trigger)&&(g+f.length>1?d.trigger.apply(d,g?f:[e].concat(c.rest(f,0))):d.trigger(e)),h}}(),e.triggerMethod=function(){return e._triggerMethod(this,arguments)},e.triggerMethodOn=function(a){var b=c.isFunction(a.triggerMethod)?a.triggerMethod:e.triggerMethod;return b.apply(a,c.rest(arguments))},e.MonitorDOMRefresh=function(a){function b(){a._isShown=!0,f()}function d(){a._isRendered=!0,f()}function f(){a._isShown&&a._isRendered&&e.isNodeAttached(a.el)&&c.isFunction(a.triggerMethod)&&a.triggerMethod("dom:refresh")}a.on({show:b,render:d})},function(a){function b(b,d,e,f){d&&e&&(e=a.callResult(e,b),c.isObject(e)||a.throwError("Bindings must be an object.","BindingError"),c.each(e,function(a,e){var g=c.isFunction(a)?f.func:f.str;g(b,d,e,a)}))}function d(b,d,e,g){var h=g.split(/\s+/);c.each(h,function(c){var g=b[c];g||a.throwError('Method "'+c+'" was configured as an event handler, but does not exist.',"BindingError"),f(b,d,e,g)})}function e(a,b,d,e){var f=e.split(/\s+/);c.each(f,function(c){var e=a[c];g(a,b,d,e)})}function f(a,b,c,d){a.listenTo(b,c,d)}function g(a,b,c,d){a.stopListening(b,c,d)}a.bindEntityEvents=function(a,c,e){b(a,c,e,{func:f,str:d})},a.unbindEntityEvents=function(a,c,d){b(a,c,d,{func:g,str:e})},a.proxyBindEntityEvents=function(b,c){return a.bindEntityEvents(this,b,c)},a.proxyUnbindEntityEvents=function(b,c){return a.unbindEntityEvents(this,b,c)}}(e),function(a){function d(a,b){return c.isArray(a)?a.concat(b):c.isObject(a)?c.extend({},a,b):void 0}function e(){var a=this.prototype,b=this.__super__;return a.mergeProps===b.mergeProps&&(a.mergeProps=[]),c(b._mergeProps.concat(a.mergeProps)).each(function(c){var e=a[c],f=b[c];if(e!==f){var g=d(f,e);g&&(a[c]=g)}}),this}function f(a){var b=this.extend(a);return e.call(b)}a.mixMerge=function(a,b,c){a.merge||(a.merge=f),arguments.length<3&&(c=b,b=void 0),b?c&&(a.prototype._mergeProps=(b.prototype._mergeProps||[]).concat(c)):a.prototype._mergeProps=c},a.mixMerge(b.Model,["defaults","relations"]),a.mixMerge(b.Collection),a.mixMerge(b.View,["events"]),a.mixMerge(b.Router)}(e),e.Queue=function(a){this.queueLen=a||2,this.queue=new Array(this.queueLen)},c.extend(e.Queue.prototype,{add:function(){return this.queue.length>=this.queueLen&&this.queue.shift(),this.queue.push(this.process.apply(this,c.rest(arguments,0))),this},process:function(){return arguments[0]},getPrevious:function(){return this.queue[this.queueLen-2]},getLast:function(){return this.queue[this.queueLen-1]}}),e.Queue.extend=b.Model.extend,e.Emitter=function(a){this.options=a||{},c.isFunction(this.initialize)&&this.initialize(this.options),this._callBeforeDestroy=c.once(function(){e._triggerMethod(this,"before:destroy",arguments)})},e.Emitter.extend=b.Model.extend,c.extend(e.Emitter.prototype,b.Events,{destroy:function(){return this._callBeforeDestroy.apply(this,arguments),e._triggerMethod(this,"destroy",arguments),this.stopListening(),this.off(),this},triggerMethod:e.triggerMethod,getOption:e.proxyGetOption}),e.mixMerge(e.Emitter),e.Region=function(a){this.options=a||{},this.el=this.getOption("el"),this.el=this.el instanceof b.$?this.el[0]:this.el,this.el||e.throwError('An "el" must be specified for a region.',"NoElError"),this.$el=this.getEl(this.el),c.isFunction(this.initialize)&&this.initialize.apply(this,arguments)},c.extend(e.Region,{buildRegion:function(a,b){return c.isString(a)?this._buildRegionFromSelector(a,b):a.selector||a.el||a.regionClass?this._buildRegionFromObject(a,b):c.isFunction(a)?this._buildRegionFromRegionClass(a):void e.throwError("Improper region configuration type.")},_buildRegionFromSelector:function(a,b){return new b({el:a})},_buildRegionFromObject:function(a,d){var f=a.regionClass||d||e.Region,g=c.omit(a,"selector","regionClass");a.selector&&!g.el&&(g.el=a.selector);var h=new f(g);return a.parentEl&&(h.getEl=function(d){if(c.isObject(d))return b.$(d);var e=c.result(a,"parentEl");return e.find(d)}),h},_buildRegionFromRegionClass:function(a){return new a}}),c.extend(e.Region.prototype,b.Events,{show:function(a,b){this._ensureElement(),b=b||{};var c=a!==this.currentView,d=!!this.currentView,f=c&&!b.preventDestroy,g=c||b.forceShow;return f?this.empty():d&&g&&this.currentView.off("destroy",this.empty,this),g&&(a.once("destroy",this.empty,this),a.render(),d&&this.triggerMethod("before:swap",a),this.triggerMethod("before:show",a),e.triggerMethodOn(a,"before:show"),this.attachViewHtml(a),this.currentView=a,d&&this.triggerMethod("swap",a),this.triggerMethod("show",a),e.triggerMethodOn(a,"show")),this},showHtml:function(a){return this._ensureElement(),this.empty(),this.attachHtml(a),this},_ensureElement:function(){c.isObject(this.el)||(this.$el=this.getEl(this.el),this.el=this.$el[0]),this.$el&&0!==this.$el.length||e.throwError('An "el" '+this.$el.selector+" must exist in DOM")},getEl:function(a){return b.$(a)},attachViewHtml:function(a){this.attachHtml(a.el)},attachHtml:function(a){this.$el.html(a)},empty:function(){var a=this.currentView;if(a)return this.triggerMethod("before:empty",a),this._destroyView(),this.triggerMethod("empty",a),delete this.currentView,this},_destroyView:function(){var a=this.currentView;a.destroy&&!a.isDestroyed?a.destroy():a.remove&&(a.remove(),a.isDestroyed=!0)},attachView:function(a){return this.currentView=a,this},hasView:function(){return!!this.currentView},reset:function(){return this.empty(),this.$el&&(this.el=this.$el.selector),delete this.$el,this},getOption:e.proxyGetOption,triggerMethod:e.triggerMethod}),e.Region.extend=e.extend,e.RegionManager=e.Emitter.extend({constructor:function(a){this._regions={},e.Emitter.call(this,a)},addRegions:function(a,b){a=e.applyResult(a,this,arguments);var d={};return c.each(a,function(a,e){c.isString(a)&&(a={selector:a}),a.selector&&(a=c.defaults({},a,b)),d[e]=this.addRegion(e,a)},this),d},addRegion:function(a,b){var c=b instanceof e.Region?b:e.Region.buildRegion(b,e.Region);return this.triggerMethod("before:add:region",a,c),this._store(a,c),this.triggerMethod("add:region",a,c),c},get:function(a){return this._regions[a]},removeRegion:function(a){var b=this._regions[a];b.empty(),b.stopListening(),delete this._regions[a],this._setLength(),this.triggerMethod("remove:region",a,b)},removeAllRegions:function(){var a=c.keys(this._regions);c.each(a,this.removeRegion,this)},resetAllRegions:function(){var a=c.keys(this._regions);c.each(a,function(a){this._regions[a].reset()},this)},destroy:function(){return this.removeAllRegions(),e.Emitter.prototype.destroy.apply(this,arguments)},_store:function(a,b){this._regions[a]=b,this._setLength()},_setLength:function(){this.length=c.keys(this._regions).length}}),e.mixCollectionMethods(e.RegionManager.prototype,"_regions"),e.Renderer={render:function(a,b){return a?"function"==typeof a?a(b):a:""}},e.BaseView=b.View.extend({constructor:function(a){c.bindAll(this,"render"),this.options=c.extend({},c.result(this,"options"),e.callResult(a,this)),b.View.apply(this,arguments),e.MonitorDOMRefresh(this)},getTemplate:function(){return this.getOption("template")},normalizeUIKeys:function(a){var b=c.result(this,"ui"),d=c.result(this,"_uiBindings");return e.normalizeUIKeys(a,d||b)},normalizeUIValues:function(a){var b=c.result(this,"ui"),d=c.result(this,"_uiBindings");return e.normalizeUIValues(a,d||b)},configureTriggers:function(){if(this.triggers){var a=this.normalizeUIKeys(c.result(this,"triggers")),b={};return c.each(a,function(a,d){var e=c.isObject(a),f=e?a.event:a;b[d]=function(b,c){if(b){var d=b.preventDefault,g=b.stopPropagation,h=e?a.preventDefault:d,i=e?a.stopPropagation:g;h&&d&&d.call(b),i&&g&&g.call(b)}this.triggerMethod(f,{view:this,model:this.model,collection:this.collection},c)}},this),b}},delegateEvents:function(a){return this._delegateDOMEvents(a),this.bindEntityEvents(this.model,this.getOption("modelEvents")),this.bindEntityEvents(this.collection,this.getOption("collectionEvents")),this},_delegateDOMEvents:function(a){a=e.callResult(a||this.events,this),a=this.normalizeUIKeys(a),this.events=a;var d={},f=this.configureTriggers();c.extend(d,a,f),b.View.prototype.delegateEvents.call(this,d)},undelegateEvents:function(){return b.View.prototype.undelegateEvents.apply(this,arguments),this.unbindEntityEvents(this.model,this.getOption("modelEvents")),this.unbindEntityEvents(this.collection,this.getOption("collectionEvents")),this},destroy:function(){return this.isDestroyed?this:(e._triggerMethod(this,"before:destroy",arguments),this.isDestroyed=!0,e._triggerMethod(this,"destroy",arguments),this.unbindUIElements(),this.remove(),this)},bindUIElements:function(){if(this.ui){this._uiBindings||(this._uiBindings=this.ui);var a=c.result(this,"_uiBindings");this.ui={},c.each(c.keys(a),function(b){var c=a[b];this.ui[b]=this.$(c)},this)}},unbindUIElements:function(){this.ui&&this._uiBindings&&(c.each(c.keys(this.ui),function(a){delete this.ui[a]},this),this.ui=this._uiBindings,delete this._uiBindings)},render:function(){return this._ensureViewIsIntact(),this.triggerMethod("before:render",this),this._renderTemplate(),this.bindUIElements(),this.triggerMethod("render",this),this},attachElContent:function(a){return this.$el.html(a),this},_renderTemplate:function(){var a=this.getTemplate();if(a!==!1){var b=e.Renderer.render(a);return this.attachElContent(b),this}},_ensureViewIsIntact:function(){this.isDestroyed&&e.throwError('View (cid: "'+this.cid+'") has already been destroyed and cannot be used.',"ViewDestroyedError")},triggerMethod:e.triggerMethod,normalizeMethods:e.normalizeMethods,getOption:e.proxyGetOption,bindEntityEvents:e.proxyBindEntityEvents,unbindEntityEvents:e.proxyUnbindEntityEvents}),e.mixMerge(e.BaseView,b.View,["ui","triggers","modelEvents","collectionEvents"]),e.View=e.BaseView.extend({serializeData:function(){if(!this.model&&!this.collection)return{};var a=[this.model||this.collection];return arguments.length&&a.push.apply(a,arguments),this.model?this.serializeModel.apply(this,a):{items:this.serializeCollection.apply(this,a)}},serializeModel:function(a){return a.toJSON.apply(a,c.rest(arguments))},serializeCollection:function(a){return a.toJSON.apply(a,c.rest(arguments))},mixinTemplateHelpers:function(a){var b=this.getOption("templateHelpers");return c.extend(a||{},e.callResult(b,this))},_renderTemplate:function(){var a=this.getTemplate();if(a!==!1){var b=this.serializeData();b=this.mixinTemplateHelpers(b);var c=e.Renderer.render(a,b);return this.attachElContent(c),this}}}),e.Layout=e.View.extend({regionClass:e.Region,constructor:function(a){a=a||{},this._firstRender=!0,this._initRegions(a),e.View.call(this,a)},render:function(){return this._ensureViewIsIntact(),this._firstRender?this._firstRender=!1:this.regionManager.resetAllRegions(),e.View.prototype.render.apply(this,arguments)},destroy:function(){return this.isDestroyed?this:(this.regionManager.destroy(),e.View.prototype.destroy.apply(this,arguments))},addRegion:function(a,b){var c={};return c[a]=b,this._buildRegions(c)[a]},addRegions:function(a){return this.regionsDecl=c.extend({},this.regionsDecl,a),this._buildRegions(a)},removeRegion:function(a){return delete this.regionsDecl[a],this.regionManager.removeRegion(a)},getRegionManager:function(){return new e.RegionManager},_initRegionManager:function(){this.regionManager=this.getRegionManager(),this.regions={},this.listenTo(this.regionManager,"add:region",function(a,b){this.regions[a]=b}),this.listenTo(this.regionManager,"remove:region",function(a){delete this.regions[a]})},_buildRegions:function(a){var b=this,c={regionClass:this.getOption("regionClass"),parentEl:function(){return b.$el}};return this.regionManager.addRegions(a,c)},_initRegions:function(a){this._initRegionManager();var b=c.extend({},e.callResult(this.regionsDecl,this,a));c.keys(b).length&&(b=this.normalizeUIValues(b),this._buildRegions(b))}}),e.mixMerge(e.Layout,e.BaseView,["regionsDecl"]),e.History=e.Queue.extend({constructor:function(){this.history=b.history,this.defaultFragment=null,e.Queue.call(this)},add:function(a){return this.getLast()!==a&&e.Queue.prototype.add.call(this,a),this},back:function(){var a=this.getPrevious()||this.defaultFragment;return this.navigate(a,{trigger:!0})},navigate:function(a,b){return this.history.navigate(a,b),this},start:function(){return this.history.start(),this},stop:function(){return this.history.stop(),this}}),e.history=new e.History,e.Router=b.Router.extend({constructor:function(a){b.Router.apply(this,arguments),this.options=a||{};var c=this.getOption("appRoutes"),d=this.getOption("handlers"),e=this.getOption("handlersContext");this._processAppRoutes(d,c,e)},route:function(a,d,f){c.isFunction(d)?f=d:f||(f=this[d]);var g=c.bind(function(){this.trigger("before:route"),e.history.add(window.location.hash),f.apply(this,arguments)},this);return b.Router.prototype.route.call(this,a,d,g)},destroy:function(){return e._triggerMethod(this,"destroy",arguments),this.stopListening(),this.off(),this.stop(),this},stop:function(){var a=this.getOption("appRoutes");return c.each(c.keys(a),function(a){this._removeFromHistory(a)},this),this},_removeFromHistory:function(a){var d=b.history.handlers,e=c.find(d,function(b){var c=this._routeToRegExp(a);return b.route.source===c.source},this);e&&(b.history.handlers=c.without(d,e))},_processAppRoutes:function(a,b,d){var f=c.keys(b).reverse();c.each(f,function(f){var g=b[f],h=a[g];h||e.throwError('Method "'+g+'" was not found on the handlers'),d&&(h=c.bind(h,d)),this.route(f,g,h)},this)},triggerMethod:e.triggerMethod,getOption:e.proxyGetOption}),e.Slot=function(a){a||e.throwError("Region is not defined"),this.region=a},c.extend(e.Slot.prototype,{setHtml:function(a){return this.empty(),this.region.showHtml(a),this},setView:function(a){return this.empty(),this.view=new a,this.region.show(this.view),this},set:function(a){return this.empty(),this.data=c.rest(arguments),this.block=new a,this.active()},active:function(){this.block||e.throwError("Slot does not contain block","SlotActivationError"),this.data||(this.data=[]);var a=this,c=this.block;return e._triggerMethod(c,"before:prepare",this.data),b.$.when(c.prepare.apply(c,this.data)).then(function(){return c.lazy&&c._createInternalInstances(),a.region.show(c.getView()),e._triggerMethod(c,"prepare",a.data),c})},empty:function(){this.block&&(this.block.destroy(),delete this.block),this.view&&(this.view.destroy(),delete this.view)},getBlock:function(){return this.block},triggerMethod:e.triggerMethod}),e.SlotManager=e.Emitter.extend({constructor:function(a){this._slots={},e.Emitter.call(this,a)},removeSlot:function(a){this._slots[a].empty(),delete this._slots[a],this.triggerMethod("remove:slot",a)},removeSlots:function(){c.each(c.keys(this._slots),this.removeSlot,this)},addSlot:function(a,b){var c=new e.Slot(a);return this._slots[b]=c,this.triggerMethod("add:slot",b,c),c},addSlots:function(a){c.each(a,this.addSlot,this)},destroy:function(){return this.removeSlots(),e.Emitter.prototype.destroy.apply(this,arguments)}}),e.SlotKeeper=e.Emitter.extend({constructor:function(a){this.lazy===!1&&this._createInternalInstances(),e.Emitter.call(this,a)},destroy:function(){return this._callBeforeDestroy.apply(this,arguments),this._destroyInternalInstances(),e.Emitter.prototype.destroy.apply(this,arguments)},getView:function(){return this.view},getViewClass:function(){return this.viewClass},_createInternalInstances:function(){"undefined"==typeof this.view&&(this.view=this._createView()),this.view&&(this._initSlots(),this.bindEntityEvents(this.view,this.viewEvents))},_destroyInternalInstances:function(){this.slotManager&&(this.slotManager.destroy(),delete this.slotManager),this.view&&(this.unbindEntityEvents(this.view,this.viewEvents),this.view.destroy(),delete this.view)},_createView:function(){var a=this.getViewClass();return"function"!=typeof a&&e.throwError("`viewClass` is not defined","SlotKeeperInitError"),new a(this._getViewOptions())},_initSlotManager:function(){this.slots={},this.slotManager=new e.SlotManager,this.listenTo(this.slotManager,"add:slot",function(a,b){this.slots[a]=b}),this.listenTo(this.slotManager,"remove:slot",function(a){delete this.slots[a]})},_initSlots:function(){var a=this.view.regions;c.keys(a).length&&(this._initSlotManager(),this.slotManager.addSlots(a))},_getViewOptions:function(){return this.viewOptions},lazy:!1,bindEntityEvents:e.proxyBindEntityEvents,unbindEntityEvents:e.proxyUnbindEntityEvents}),e.Block=e.SlotKeeper.extend({getCollectionClass:function(){return this.collectionClass},getCollection:function(){return this.collection},getModelClass:function(){return this.modelClass},getModel:function(){return this.model},_createInternalInstances:function(){return"undefined"==typeof this.model&&(this.model=this._createModel()),this.model&&this.bindEntityEvents(this.model,this.modelEvents),"undefined"==typeof this.collection&&(this.collection=this._createCollection()),this.collection&&this.bindEntityEvents(this.collection,this.collectionEvents),e.SlotKeeper.prototype._createInternalInstances.apply(this,arguments)},_destroyInternalInstances:function(){return this.model&&(this.unbindEntityEvents(this.model,this.modelEvents),delete this.model),this.collection&&(this.unbindEntityEvents(this.collection,this.collectionEvents),this.collection.reset(),delete this.collection),e.SlotKeeper.prototype._destroyInternalInstances.apply(this,arguments)},_createModel:function(){var a=this.getModelClass();return"function"==typeof a?new a:void 0},_createCollection:function(){var a=this.getCollectionClass();return"function"==typeof a?new a:void 0},_getViewOptions:function(){var a={};return this.model&&(a.model=this.model),this.collection&&(a.collection=this.collection),c.extend(a,this.viewOptions)},prepare:e.noop}),e.mixMerge(e.Block,["viewEvents","modelEvents","collectionEvents"]),e.Bundle=e.SlotKeeper.extend({lazy:!0,constructor:function(a){this.options=a||{},this.region=this.getOption("region"),this.region||e.throwError("Region in not defined","BundleInitError"),c.bindAll(this,"_onBeforeRoute","_onRegionSwap"),this.isActive=!1,this._routers={},this.listenTo(this.region,"swap",this._onRegionSwap),e.SlotKeeper.call(this,this.options)},initRouter:function(a){var b=this._routers[a]=new this.routersDecl[a]({handlersContext:this});return this.listenTo(b,"before:route",this._onBeforeRoute),b.triggerMethod("init",this),b},initRouters:function(){c.each(c.keys(this.routersDecl),function(a){this.initRouter(a)},this)},getRouter:function(a){return"undefined"==typeof this._routers[a]&&e.throwError("Router is not initialized"),this._routers[a]},_onBeforeRoute:function(){this.isActive||(this._destroyInternalInstances(),this._createInternalInstances(),this.region.show(this.view),this.isActive=!0,this.triggerMethod("render"),c.each(c.keys(this._routers),function(a){this._routers[a].triggerMethod("render",this)},this))},_onRegionSwap:function(){this.isActive=!1},destroy:function(){return c.each(c.keys(this._routers),function(a){this._routers[a].destroy(this),delete this._routers[a]},this),e.SlotKeeper.prototype.destroy.apply(this,arguments)}}),e});